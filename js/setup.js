if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

// Scene, Camera, Renderer
let renderer	= new THREE.WebGLRenderer();
let scene		= new THREE.Scene();
let aspect		= window.innerWidth / window.innerHeight;
let camera		= new THREE.PerspectiveCamera(45, aspect, 0.1, 1500);
let controls	= new THREE.OrbitControls(camera);
let info		= document.getElementById( 'info' );
var listener	= new THREE.AudioListener(); // instantiate a listener
let controlsEnabled = false;

var velocity = new THREE.Vector3();
var acceleration = new THREE.Vector3();
var cowrand = new THREE.Euler( 2 * Math.PI * Math.random(), 2 * Math.PI * Math.random(), 2 * Math.PI * Math.random(), 'XYZ' );

// XHR Loading functions
// Function called when download progresses
var onProgress = function ( xhr ) { 
	if ( xhr.lengthComputable ) {
		var percentComplete = xhr.loaded / xhr.total * 100;
		console.log( Math.round(percentComplete, 2) + '% downloaded' );
	}
};
// Function called when download errors
var onError = function ( xhr ) {
	console.log( 'An error happened' );
};

var totalCalls = ajaxCallsRemaining = 11;
var moourls = [];
var returnedMoos = [];
var winmoo = new Audio('./media/sounds/win.mp3');

var cow;
var earth;
var tractor; 
var cow_svg = document.getElementById( 'cow-svg' );

init();

// Setup Libraries, Acquire Locks, and Load Assets
function init() {
	// Instantiate Threejs loader which sets up and inits AudioContext
	var loader = new THREE.AudioLoader();
	
	// Array of Sounds to Load
	for (var i = 0; i <= 10; i++) {
		moourls.push('./media/sounds/'+i+'.mp3');
	}
	
	moourls.forEach(function(listItem, index){
		// Load sound
		loader.load(
			// Resource URL
			listItem,
			// Function when resource is loaded
			function ( audioBuffer ) {
				// Success Handler from Ajax call
				returnedMoos[index] = audioBuffer; // Save audioBuffer response
				// See if we're done with the last ajax call
				--ajaxCallsRemaining;
				info.innerHTML = "Loading Progress " + ((totalCalls - ajaxCallsRemaining)/totalCalls*100) + " %";
				if (ajaxCallsRemaining <= 0) {
					// All resources loaded! Unlock Game
					unlock();
				}
			},
			// Function called when download progresses
			onProgress,
			// Function called when download errors
			onError
		);
	});
	
	// Start Loading Non-Audio Assets

	// Lights
	let spotLight = new THREE.SpotLight(0xffffff, .25, 0, 10, 2);
	let ambientLight = new THREE.AmbientLight( 0x404040 ); // soft white light
	
	// Texture Loader
	let textureLoader = new THREE.TextureLoader();
	
	// Earth
	earth = createPlanet({
	  surface: {
		size: .995,
		material: {
		  bumpScale: 0.25,
		  specular: new THREE.Color('grey'),
		  shininess: 10
		},
		textures: {
		  map: '',//'https://s3-us-west-2.amazonaws.com/s.cdpn.io/141228/earthmap1k.jpg',
		  bumpMap: 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/141228/earthbump1k.jpg',
		  specularMap: 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/141228/earthspec1k.jpg'
		}
	  },
	  atmosphere: {
		size: 0.005,
		material: {
		  opacity: 0.8
		},
		textures: {
		  map: 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/141228/earthcloudmap.jpg',
		  alphaMap: 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/141228/earthcloudmaptrans.jpg'
		},
		glow: {
		  size: 0.02,
		  intensity: 0.7,
		  fade: 7,
		  color: 0x93cfef
		}
	  },
	});


	// Galaxy
	let galaxyGeometry = new THREE.SphereGeometry(100, 32, 32);
	let galaxyMaterial = new THREE.MeshBasicMaterial({
	  side: THREE.BackSide
	});
	let galaxy = new THREE.Mesh(galaxyGeometry, galaxyMaterial);

	// Load Galaxy Textures
	textureLoader.crossOrigin = true;
	textureLoader.load(
	  'https://s3-us-west-2.amazonaws.com/s.cdpn.io/141228/starfield.png',
	  function(texture) {
		galaxyMaterial.map = texture;
		scene.add(galaxy);
	  }
	);
	
	// Tractor Beam
	var tract_geometry = new THREE.CylinderGeometry( .007, .007, .1, 32, 1, true);
	var tract_material = new THREE.MeshLambertMaterial( {color: 0xf0f0f0} );
	tractor = new THREE.Mesh( tract_geometry, tract_material );
	
	// Cow
	var cow_geometry = new THREE.BoxGeometry( 20, 20, 20 );
	var cow_material = new THREE.MeshPhongMaterial( { specular: 0xffffff, shading: THREE.FlatShading, vertexColors: THREE.VertexColors } );
	cow = new THREE.Mesh( cow_geometry, cow_material );
	cow.position.set(0,.95,0);
	cow.visible = false;
	
	// Scene, Camera, Renderer Configuration
	renderer.setSize(window.innerWidth, window.innerHeight);
	document.body.appendChild(renderer.domElement);

	camera.position.set(1,1,1);

	scene.add(camera);
	scene.add(spotLight);
	scene.add(ambientLight);
	scene.add(earth);
	scene.add(tractor);

	//scene.fog = new THREE.FogExp2( 0x000000, 0.0025 );

	// Light Configurations
	spotLight.position.set(1,1,1);
	spotLight.lookAt(earth.position);

	// Mesh Configurations
	earth.receiveShadow = true;
	earth.castShadow = true;
	earth.getObjectByName('surface').geometry.center();

}

var current_sound;
// Runs once after page is loaded
function unlock() {
	blocker = document.getElementById( 'blocker' );
	instructions = document.getElementById( 'instructions' );

	var lockchange = function ( event ) {
		if ( pause ) {
			controls.enabled = false;
			
			//var delta = clock.getDelta(); // Added to prevent movement

			blocker.style.display = '-webkit-box';
			blocker.style.display = '-moz-box';
			blocker.style.display = 'box';

			if (cow_svg.style.display == 'none'){
				// Do nothing
			} else {
				// change to moo sound via transition
				/* 
			<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1384 1024">
			  <title>cow-sound</title>
			  <path fill="#f9f1e6" class="path1 fill-color12" d="M831.83 160.68s23.607-24.554 73.663-21.28 3.274-1.594 3.274-1.594c-1.35-7.399-10.314-19.582-22.389-27.347s18.124-4.444 42.42 10.633c0 0-3.791-48.462 38.21-54.924 0 0-12.923 36.788-1.292 58.327 0 0 24.813-28.001 37.391-26.148 0 0-12.191 20.462-12.191 39.502 0 0 151.504-7.194 188.465 62.118 0 0 136.772-103.042 182.003-59.964 0 0 37.348 20.462-6.117 58.5s-118.507 47.041-155.855 47.041c0 0 37.693 142.156 37.693 161.197 0 0-109.848-58.155-266.349-43.078s-208.582 28.345-264.928 70.001-127.079 111.657-73.577 240.158l11.502 10.769-52.426 7.194 13.268 227.192-90.463-27.268 10.769-78.574 1.077-118.808-93.694-11.114-70.346-30.154 7.883 89.386-67.503-29.422 9.994-89.602-72.887-53.847 8.271 146.895-29.077 11.502-40.924-16.197 5.040-142.889-21.883-127.812-3.619-68.58 32.653-121.35-36.271 20.247-44.499 65.047-26.924 64.918-14.345-7.194 5.729-18.308 47.041-95.202 55.656-72.887 53.503-26.579 34.807-50.961 88.309-47.73 117.042-14.345 138.883 19.73 104.808 35.884 29.077 47.041 29.077 25.847 60.093-36.013z"></path>
			  <path fill="#a87451" class="path2 fill-color4" d="M718.105 119.971l45.921 77.841 46.955 12.622 24.985-18.308 7.84-12.493-16.111-22.487-27.57-26.708-13.957-17.791-15.077-40.752 0.345-33.816-3.015-16.8-13.483 2.283-23.133 14-18.093 31.748 4.437 50.616zM1134.408 8.529s30.413-4.652 51.952 31.231 29.077 76.118-6.031 110.58-65.133 51.176-91.54 9.606l5.902-14.991 43.078-48.075 9.046-33.299-3.705-20.979-8.616-21.108v-12.88z"></path>
			  <path fill="#f9f1e6" class="path3 fill-color12" d="M716.554 753.429l-1.465 70.346 12.234 73.232-68.235-11.459 10.080-86.888 2.154-78.961 45.232 33.73zM759.029 779.276l-4.308 44.155s24.813 112.002 231.586 52.253c0 0 89.946-37.693 119.541-87.232 0-0.215-194.367 29.939-346.775-9.176z"></path>
			  <path fill="#fff" class="path4 fill-color13" d="M1072.936 791.208s-126.218 70.906-210.822 50.142-72.629-53.933-72.629-53.933 170.071 31.791 283.451 3.791z"></path>
			  <path fill="#eaa18c" class="path5 fill-color6" d="M994.923 360.69c75.558-0.991 370.468 29.637 347.852 211.081s-146.464 208.927-369.348 228.872-354.314-76.463-365.6-229.906 264.842-208.496 387.096-210.090z"></path>
			  <path fill="#f4b5b5" class="path6 fill-color8" d="M713.884 245.112s13.957-27.785-76.075-54.106l-15.077 5.169-4.868 9.305 2.455 11.329 41.527 19.557zM1204.366 224.133l6.763-16.886 22.831-14.517 14.56-6.16 46.309-3.705h9.692l-3.145 16.886-65.22 23.564-16.154 5.299-15.594-4.437z"></path>
			  <path fill="#000" class="path7 fill-color1" d="M984.325 355.822c-354.831 8.185-380.376 200.182-378.222 225.555 22.4 263.851 337.858 224.952 394.376 222.281s343.329-15.766 350.911-222.539-243.906-228.053-367.022-225.296zM1335.15 581.118c-7.194 196.434-281.297 208.798-335.274 211.339s-355.176 39.631-376.499-211.081c-2.154-24.124 22.228-206.558 361.12-214.225 117.731-2.585 357.89 17.446 350.652 213.967zM1165.036 10.554c-12.493-12.665-52.426-19.73-36.271 13.656s19.385 52.038-19.73 92.617-34.118 43.078-17.231 61.256c18.006 19.299 55.269 18.523 86.888-23.262 9.262-12.234 70.346-58.715-13.656-144.31zM1163.227 155.597c-24.382 23.133-45.059 29.207-58.284 17.748-11.416-9.736-12.406-15.25-12.191-19.643 0.732-15.077 27.785-22.53 48.678-60.826 17.533-32.050 3.274-54.924-1.034-65.133-9.606-22.831 8.616-19.557 23.434-5.169 19.557 19.083 31.145 37.736 33.041 60.61 1.723 21.797-3.705 44.068-33.601 72.371zM813.953 135.824c-32.007-26.45-41.699-60.653-38.468-87.965 8.185-69.14-47.385-20.419-58.5 0-33.041 60.74 17.231 124.495 39.847 144.31 38.339 34.031 60.74 25.588 76.851 9.994 25.674-24.554 12.234-39.847-19.816-66.34zM831.917 185.708c-14 28.259-53.847 14.517-85.423-25.847-10.769-13.699-24.296-34.462-28.431-59.146-6.117-36.961 21.539-71.38 38.77-75.731s3.619 25.416 7.582 46.265c1.199 19.531 14.71 47.807 35.245 69.322 18.215 20.064 41.305 26.655 32.258 45.179z"></path>
			  <path fill="#000" class="path8 fill-color1" d="M1111.405 125.098s39.804 41.182 58.844 31.619-1.422-5.945-1.422-5.945c-18.373-2.153-37.405-15.238-48.282-33.701zM1132.427 100.371s27.57 29.293 61.816 16.37l0.775-7.194s-33.299 8.099-57.293-17.231zM1141.128 69.57s33.299 24.985 62.161 9.391l-6.203-5.342s-25.416 10.339-52.124-11.976zM1146.384 46.955s22.616 14 38.038-8.96l-6.246-7.323s-6.634 18.954-34.462 7.84zM764.629 184.286s37.908-11.114 46.093-38.253l-6.462-7.323s-20.763 32.308-45.533 35.496 5.902 10.080 5.902 10.080zM790.476 114.285s-24.339 33.041-60.524 27.44l-4.308-7.323s45.232 0.302 58.5-27.699zM778.069 88.439s-36.616 26.45-66.426 6.591v-8.616s31.447 13.871 61.601-5.514zM765.706 57.121s-25.847 13.483-48.462-4.308l2.154-10.339s22.96 19.73 46.309 6.117v8.616zM1336.27 125.356c-71.251-2.283-153.357 66.512-153.357 66.512-0.192-3.831-11.851-17.259-26.644-25.908l0.496 0.664c1.162-0.537-3.166 5.902-8.9 10.721 26.347 18.443 33.842 37.096 33.842 37.096 55.355-67.761 158.612-91.325 182.434-67.761 10.339 10.252 4.997 27.57-5.729 40.622-50.272 60.826-172.655 49.453-172.655 49.453 44.715 92.617 43.078 169.166 43.078 169.166l12.923 5.945c1.034-62.463-37.391-162.403-37.391-162.403 166.926-1.292 231.887-120.618 131.947-124.064zM892.441 112.519c9.009 6.114 17.601 19.095 20.199 34.129-5.176-0.341-11.218-0.726-17.35-0.726-23.079 0-44.884 5.45-64.2 15.133-0.34-3.246-3.819-6.43-8.109-7.798 21.994-10.905 48.004-17.265 75.499-17.265 0.406 0 0.812 0.001 1.218 0.004s-1.527-10.081-23.066-26.278c0 0 10.769-15.508 46.869 6.031 0 0-10.769-40.924 52.253-59.275 0 0-13.957 43.078-6.462 60.912 0 0 5.428-23.133 44.801-23.133 0 0-17.231 21.022-18.696 37.176 31.105 0.024 66.761 3.989 101.107 11.462-5.814 1.335-7.402 4.337-7.402 7.709 0 0.288 0.012 0.573 0.034 0.855-24.635-6.279-52.912-9.861-82.027-9.861-7.212 0-14.373 0.22-21.476 0.653s-0.317-21.931 9.591-36.664c-11.808 3.797-22.357 15.072-25.788 29.136s-24.096-17.29-6.865-62.177c0 0-29.422-1.422-33.041 54.579-0.086-0.086-23.779-16.8-37.047-14.56zM770.531 189.714c19.321-20.17-5.93 2.282-24.839 29.474s-123.952-134.152-195.719-66.693 101.405 112.433 169.295 117.43c0 0-42.216 105.11-19.256 160.421l13.914-7.194s-26.407-27.699 22.4-161.972c0 0-224.004-33.428-177.739-94.34 54.536-71.811 188.81 74.697 188.81 74.697-11.923 15.89 6.61-15.905 31.494-41.49-6.509-2.88-8.362-6.628-8.362-10.289z"></path>
			  <path fill="#000" class="path9 fill-color1" d="M1307.408 185.406c-11.846-10.339-37.908-10.856-63.152-1.852-30.154 10.769-56.992 40.493-43.078 43.078 18.523 3.662 29.896 2.369 71.509-10.037s46.222-20.979 34.721-31.145zM1255.715 213.192c-34.893 7.883-46.093 11.717-46.222 2.585 0-4.566 19.945-20.117 36.013-25.071 22.53-6.892 41.484-7.108 52.555-0.431 8.96 5.6-5.299 14.431-42.647 22.831zM674.597 196.219c-38.77-17.748-63.755-11.071-61.903 8.917 2.585 26.88 75.386 37.047 102.525 42.475s-1.852-33.601-40.579-51.392zM637.808 219.265c-13.483-4.049-12.923-12.493-12.923-17.231 0-22.745 53.718 6.591 73.232 20.677 39.976 29.379-24.124 7.539-60.309-3.446zM990.787 798.057c0.129 1.926 0.202 4.174 0.202 6.44 0 8.165-0.953 16.107-2.753 23.722l7.161-3.066s4.739-8.012 2.585-27.139h-7.237zM1018.529 792.199c0.613 2.791 0.963 5.997 0.963 9.286 0 5.044-0.825 9.894-2.349 14.425l7.201-0.319c0.476-3.025 0.748-6.514 0.748-10.066 0-4.7-0.476-9.289-1.384-13.721z"></path>
			  <path fill="#000" class="path10 fill-color1" d="M1093.312 788.882c-85.725 131.258-283.365 99.079-313.864 68.924-23.090-22.831-19.945-60.912-13.139-82.709q-6.677-2.369-12.923-4.997c-39.071 130.741 106.574 140.864 211.942 116.741 110.968-25.416 153.787-105.627 153.787-105.627z"></path>
			  <path fill="#000" class="path11 fill-color1" d="M906.786 847.64c92.402-8.616 176.274-54.106 176.274-54.106l-17.963 1.077c-25.847 14.302-117.301 41.57-165.332 43.078s-85.38-20.333-95.632-31.447c1.988 3.853-8.881-8.028-16.013-22.121-5.052-1.701-9.834-2.95-14.443-4.372 5.859 19.816 46.524 76.032 133.11 67.934z"></path>
			  <path fill="#000" class="path12 fill-color1" d="M825.369 828.384c-0.593-5.477-0.932-11.831-0.932-18.263 0-4.063 0.135-8.094 0.401-12.089l-9.334-1.181c-0.208 2.559 0.876 14.88 2.9 26.882zM859.659 837.646l7.452 3.446c-2.195-13.258-3.45-28.536-3.45-44.107 0-0.517 0.001-1.033 0.004-1.549l-9.607-1.084c0.646 15.077 2.154 35.97 5.6 43.293zM895.155 843.461l5.6-3.102c0-4.911-1.292-27.44-2.068-41.785l-7.754-0.517c0.005 15.642 1.573 31.538 4.561 46.926zM926.429 842.729h7.668s0.517-17.231-0.646-42.388l-8.012-0.302zM959.513 800.513c0.345 9.908 0.646 28.862-1.982 36.013h6.462c1.106-8.375 1.738-18.059 1.738-27.89 0-2.826-0.052-5.64-0.156-8.441l-6.019 0.405zM79.952 387.699s28.604 9.908 33.859 82.149c2.585 35.97 13.699 133.11-14.216 74.007 0 0 14.043 90.032-20.247 17.231 0 0 30.93 106.833-28.948 11.889 0 0-14.646 55.269-35.065-83.571 0 0-28.001 23.52-8.357-17.231s46.093-86.802 72.974-84.475z"></path>
			  <path fill="#000" class="path13 fill-color1" d="M58.155 408.204l5.729 0.258c66.038-164.557 128.372-205.653 153.357-215.819-14.931 30.054-3.985 3.724 11.422-19.375-102.015 16.877-170.508 234.936-170.508 234.936z"></path>
			  <path fill="#000" class="path14 fill-color1" d="M76.808 409.066l10.769 0.517c20.677-98.648 72.371-136.815 100.371-150.772-0.831-0.607 2.658-12.946 8.299-24.003-90.276 46.059-119.439 174.258-119.439 174.258zM921.863 287.759c0.302 21.194-32.093 28.517-27.914-2.369s16.068-27.354 20.85-23.047 6.979 15.594 7.108 25.416zM1048.597 280.005c-0.431-18.093-20.117-34.893-24.425-8.616s6.462 29.379 12.191 28.69 12.579-6.031 12.234-20.117zM884.127 501.726c17.748-2.757 36.745 24.554 16.37 45.145s-37.047-10.597-35.065-27.311c1.194-9.51 8.96-17.005 18.623-17.786zM1080.087 491.732c14.129-3.748 31.877 22.487 11.502 42.475s-34.462-9.779-30.801-21.108c3.877-12.32 6.892-18.093 19.299-21.323z"></path>
			  <path fill="#000" class="path15 fill-color1" d="M244.811 158.095s127.079 70.217 59.232 186.526-146.464 63.927-146.464 63.927-9.692-139.443 87.232-250.281zM323.729 448.439c-28.302-78.66 36.185-108.814 72.801-29.724s-34.333 136.556-72.801 29.724zM628.504 685.926s-157.061-75.171-130.095-253.555 207.807-63.324 207.807-63.324-9.692 34.118 8.185 63.324c0 0-154.132 69.614-66.857 251.272 0 0-4.868 14.646-19.083 2.283zM580.817 142.415s-133.541-34.721-175.197 41.872 9.046 172.052 199.148 51.047c0 0-118.722-51.262-23.994-92.919zM240.675 596.928s-66.9 12.191 5.6 81.848zM528.434 716.081s92.617 53.072 0 112.347v-112.304zM696.308 832.692c11.071 30.801 33.299 11.286 17.662-19.471s-27.44-7.754-17.662 19.471z"></path>
			  <path fill="#000" class="path16 fill-color1" d="M714.357 925.74c-0.705 2.27 2.66 19.796 8.466 36.166 1.962-0.199 17.231-8.719 29-20.689s-34.149-95.903-31.090-186.366l-13.354-10.769c-0.19 30.42 4.637 82.361 13.73 132.82-8.829-0.855-18.425 1.822-28.646 1.822-8.534 0-16.632-1.866-23.908-5.212 5.526-46.808 9.532-111.166 1.046-163.333l-9.132-5.902s12.062 131.042-17.231 240.158c0 0 29.508 25.847 65.995 19.902 1.545-4.329 4.256-20.955 5.145-38.063z"></path>
			  <path fill="#000" class="path17 fill-color1" d="M652.627 691.828l-8.616-10.166c-15.734 2.455-33.882 3.857-52.357 3.857-2.417 0-4.829-0.024-7.235-0.072s0.662 116.315 12.853 211.948c-8.2 2.995-17.667 4.727-27.539 4.727-17.869 0-34.413-5.676-47.926-15.322 9.427-56.347 17.482-131.087 11.021-197.987 0 0-168.434 4.868-325.237-162.058 1.209 15.431 10.908 32.325 25.266 43.525s3.682 76.36 11.35 138.306c-11.373 6.332-36.056 16.37-58.801 0.862 3.014-24.676 4.733-53.244 4.733-82.214s-1.72-57.538-5.062-85.608c-14.92-122.263-63.598-213.803 65.118-380.945s450.162-39.89 471.701-27.139l-11.2-21.022s-344.191-132.033-470.193 39.201c-140.003 190.317-80.771 292.928-68.924 393.041s-8.616 234.946-8.616 234.946 28.862 34.247 66.167 28.561c2.127-7.747 3.349-16.642 3.349-25.823 0-2.889-0.121-5.75-0.358-8.578-0.042 6.877 3.536 19.939 9.527 31.553 4.974-0.501 21.371-11.097 33.149-25.597s-26.454-37.421-30.029-198.317c0 0 131.042 117.43 277.119 119.584 0 0 15.077 141.424-37.348 278.583 0 0 40.321 41.656 84.432 44.37 3.575-7.668 8.271-22.185 9.908-47.945-0.694 3.46 2.604 26.645 8.506 48.767 14.627-5.086 29.489-13.917 42.627-31.536 0 0-34.979-95.891-33.385-295.944 0.258 0 49.884-2.843 55.915-5.6z"></path>
			  <path fill="#000" class="path18 fill-color1" d="M348.24 749.466v0c-0.006 6.591 2.012 16.914 5.591 26.476 8.71-1.379 21.972-8.494 31.632-18.98s-16.417-35.884-19.346-103.429l-8.616-4.308c-0.011 19.070 1.883 43.615 5.507 67.593-6.128-0.522-12.822 0.749-19.813 0.749-12.056 0-23.229-3.781-32.398-10.221 2.765-26.674 5.565-58.466 5.78-78.023l-10.554-12.363s1.938 78.401-16.714 145.172c0 0 26.708 17.231 56.001 14.646 1.93-6.648 3.041-14.284 3.041-22.179 0-1.775-0.056-3.537-0.167-5.284z"></path>
			</svg>
				*/
			}
			
			instructions.style.display = '';
			info.innerHTML = "Paused";
			document.removeEventListener( 'mousedown', checkmoo, false);
			document.removeEventListener( 'mousemove', onMouseMove, false );
		} else {

			controlsEnabled = true;
			controls.enabled = true;
			
			//var delta = clock.getDelta(); // Added to prevent movement
			
			blocker.style.display = 'none';
			cow_svg.style.display == 'none';
			
			document.addEventListener( 'mousedown', checkmoo, false);
			document.addEventListener( 'mousemove', onMouseMove, false );
			info.innerHTML = "moo.";
		}

	};

	// Hook pointer lock state change events
	document.addEventListener("pause", lockchange, false );
	
	instructions.addEventListener( 'click', function ( event ) {
		instructions.style.display = 'none'; 
		
		// Unlock Pause
		pause = false;
		document.dispatchEvent(pauseEvent);
	}, false );
	
	info.innerHTML = "Resources Loaded, click to begin.";
	
	sound = new THREE.PositionalAudio( listener );
	sound.setBuffer( returnedMoos[0] );
	sound.setRefDistance( 0.05 );
	sound.setMaxDistance( 2.10 );
	sound.setRolloffFactor( 1 );
	sound.setDistanceModel('linear');
	sound.setLoop(true);
	sound.play();
	
	current_sound = 0;
	
	cow.position.applyEuler(cowrand);
	cow.add(sound);
	scene.add(cow);
	
	// events

	addEventListeners();

	animate();
}

var audioPos = new THREE.Vector3();
var audioRot = new THREE.Euler();

function animate() {
	// Move atmosphere
	earth.getObjectByName('atmosphere').rotation.y += 1/16 * 0.005;
	
	camera.lookAt(earth.position);
	
	renderer.render( scene, camera );

	stats.update();

	requestAnimationFrame( animate );
}

function checkmoo(event){
	console.log(tractor.position.distanceTo(cow.position));
	
	if(tractor.position.distanceTo(cow.position) < 0.05) {
		cowsfound++;
		
		info = document.getElementById( 'info' );
		info.innerHTML = cowsfound <= 1 ? cowsfound + " moo" : cowsfound + " moos";
		
		sound.pause();
		winmoo.play();
		blocker = document.getElementById( 'blocker' );
		
		cow_svg.innerHTML = "\
<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 1384 1024\">\
  <title>cow</title>\
  <path fill=\"#f9f1e6\" class=\"path1 fill-color12\" d=\"M831.83 160.68s23.607-24.554 73.663-21.28 3.274-1.594 3.274-1.594c-1.35-7.399-10.314-19.582-22.389-27.347s18.124-4.444 42.42 10.633c0 0-3.791-48.462 38.21-54.924 0 0-12.923 36.788-1.292 58.327 0 0 24.813-28.001 37.391-26.148 0 0-12.191 20.462-12.191 39.502 0 0 151.504-7.194 188.465 62.118 0 0 136.772-103.042 182.003-59.964 0 0 37.348 20.462-6.117 58.5s-118.507 47.041-155.855 47.041c0 0 37.693 142.156 37.693 161.197 0 0-109.848-58.155-266.349-43.078s-208.582 28.345-264.928 70.001-127.079 111.657-73.577 240.158l11.502 10.769-52.426 7.194 13.268 227.192-90.463-27.268 10.769-78.574 1.077-118.808-93.694-11.114-70.346-30.154 7.883 89.386-67.503-29.422 10.037-89.386-72.801-53.847 8.185 146.809-29.034 11.502-40.924-16.154 5.040-142.889-21.97-127.941-3.575-68.58 32.653-121.35-36.315 20.203-44.499 64.875-26.924 64.961-14.345-7.194 5.729-18.308 47.041-95.072 55.656-72.887 53.503-26.579 34.807-50.961 88.309-47.73 117.042-14.345 138.839 19.73 104.808 35.884 29.077 47.041 29.121 25.847 60.093-36.013z\"></path>\
  <path fill=\"#a87451\" class=\"path2 fill-color4\" d=\"M718.105 119.971l45.921 77.841 46.955 12.622 24.985-18.308 7.84-12.493-16.111-22.487-27.57-26.708-13.957-17.791-15.077-40.752 0.345-33.816-3.015-16.8-13.483 2.283-23.133 14-18.093 31.748 4.437 50.616zM1134.408 8.529s30.413-4.652 51.952 31.231 29.077 75.946-6.031 110.408-65.133 51.176-91.54 9.606l5.902-15.077 43.078-48.032 9.046-33.256-3.791-20.85-8.616-21.194v-12.923z\"></path>\
  <path fill=\"#f9f1e6\" class=\"path3 fill-color12\" d=\"M716.554 753.429l-1.465 70.346 12.234 73.232-68.235-11.459 10.080-86.888 2.154-78.961 45.232 33.73z\"></path>\
  <path fill=\"#eaa18c\" class=\"path4 fill-color6\" d=\"M995.095 360.69c75.558-0.991 370.468 29.637 347.852 211.081s-146.464 208.927-369.391 228.872-354.314-76.463-365.6-229.906 264.712-208.453 387.139-210.090z\"></path>\
  <path fill=\"#f4b5b5\" class=\"path5 fill-color8\" d=\"M713.884 244.94s14.129-27.828-76.075-54.106l-15.077 5.169-4.868 9.305 2.455 11.329 41.527 19.514zM1204.366 224.133l6.763-16.886 22.831-14.517 14.56-6.16 46.309-3.705h9.692l-3.145 16.886-65.22 23.564-16.154 5.299-15.594-4.437z\"></path>\
  <path fill=\"#000\" class=\"path6 fill-color1\" d=\"M984.153 355.822c-354.831 8.185-380.376 200.182-378.222 225.555 22.4 263.851 337.858 224.952 394.376 222.281s343.588-15.939 351.083-222.712-243.906-227.881-367.194-225.081zM1335.15 581.032c-7.194 196.434-281.297 208.798-335.274 211.339s-355.176 39.631-376.499-211.081c-2.154-24.124 22.228-206.558 361.12-214.225 117.731-2.455 357.89 17.576 350.652 214.010zM1165.036 10.339c-12.493-12.665-52.426-19.73-36.271 13.656s19.385 52.038-19.73 92.617-34.118 43.078-17.231 61.256c18.006 19.256 55.269 18.523 86.888-23.262 9.262-12.062 70.561-58.586-13.656-144.31zM1163.098 155.51c-24.425 23.262-45.059 29.121-58.327 17.834-11.416-9.736-12.406-15.25-12.191-19.643 0.732-15.077 27.785-22.53 48.678-60.826 17.533-32.050 3.274-54.924-1.034-65.133-9.649-22.831 8.616-19.557 23.391-5.169 19.557 19.083 31.145 37.736 33.041 60.61 1.895 21.97-3.446 44.068-33.601 72.371zM813.953 135.824c-32.007-26.407-41.699-60.869-38.555-87.965 8.185-69.14-47.385-20.419-58.5 0-33.041 60.74 17.231 124.495 39.847 144.31 38.339 34.031 60.74 25.588 76.894 9.994 25.545-24.554 12.32-39.847-19.687-66.34zM831.917 185.708c-14 28.259-53.847 14.517-85.423-25.847-10.769-13.699-24.296-34.462-28.431-59.146-6.117-36.961 21.539-71.38 38.77-75.731s3.619 25.416 7.582 46.265c1.199 19.531 14.71 47.807 35.245 69.322 18.215 20.064 41.305 26.655 32.258 45.179z\"></path>\
  <path fill=\"#000\" class=\"path7 fill-color1\" d=\"M1111.405 125.098s39.804 41.182 58.844 31.619-1.422-5.945-1.422-5.945c-18.373-2.153-37.405-15.238-48.282-33.701zM1132.427 100.371s27.57 29.293 61.816 16.37l0.775-7.323s-33.299 8.099-57.293-17.231zM1141.128 69.57s33.299 24.985 62.161 9.391l-6.203-5.342s-25.416 10.339-52.124-11.976zM1146.384 47.17s22.616 14 38.038-8.96l-6.031-7.539s-6.634 19.040-34.462 7.883zM764.457 184.286s38.038-11.114 46.309-38.21l-6.462-7.323s-20.763 32.308-45.533 35.539 5.729 10.037 5.729 10.037zM790.605 114.285s-24.554 33.041-60.653 27.484l-4.308-7.323s45.232 0.345 58.5-27.656zM778.069 88.439s-36.616 26.45-66.426 6.591v-8.616s31.576 14 61.73-5.385zM765.706 57.121s-25.847 13.483-48.462-4.308l2.154-10.339s22.96 19.73 46.309 6.117v8.616zM1336.27 125.356c-71.251-2.283-153.357 66.512-153.357 66.512-0.192-3.831-11.851-17.259-26.644-25.908l0.496 0.664c1.162-0.537-3.166 5.902-8.9 10.721 26.347 18.443 33.842 37.096 33.842 37.096 55.355-67.761 158.612-91.325 182.434-67.761 10.339 10.252 4.997 27.57-5.729 40.622-50.272 60.826-172.655 49.453-172.655 49.453 44.715 92.617 43.078 169.166 43.078 169.166l12.923 5.945c1.077-62.463-37.133-162.403-37.133-162.403 166.711-1.292 231.629-120.747 131.689-124.064zM892.441 112.519c9.009 6.114 17.601 19.095 20.199 34.129-5.176-0.341-11.218-0.726-17.35-0.726-23.079 0-44.884 5.45-64.2 15.133-0.365-3.293-3.873-6.488-8.195-7.842 21.994-10.904 48.003-17.264 75.498-17.264 0.376 0 0.752 0.001 1.128 0.004s-1.652-9.994-23.191-26.148c0 0 10.769-15.637 46.869 5.902 0 0-10.769-40.924 52.296-59.232 0 0-14 43.078-6.462 60.869 0 0 5.385-23.133 44.715-23.133 0 0-17.231 21.022-18.653 37.176 30.906 0.023 66.622 4.005 101.024 11.507-5.793 1.334-7.364 4.321-7.364 7.676 0 0.299 0.012 0.595 0.037 0.887-24.75-6.34-53.159-9.957-82.414-9.957-7 0-13.952 0.207-20.849 0.615s-0.342-21.928 9.566-36.661c-11.808 3.797-22.357 15.072-25.788 29.136s-24.096-17.247-6.865-62.177c0 0-29.422-1.378-33.041 54.623 0 0-23.693-16.671-36.961-14.474zM770.531 189.714c19.321-20.17-5.93 2.282-24.839 29.474s-123.952-134.152-195.719-66.693 101.362 112.433 169.425 117.43c0 0-42.216 105.11-19.213 160.421l13.914-7.194s-26.407-27.699 22.4-161.972c0 0-224.004-33.428-177.739-94.34 54.623-71.811 188.853 74.654 188.853 74.654-11.767 15.814 6.588-16.014 31.296-41.681-6.527-2.646-8.379-6.566-8.379-10.098z\"></path>\
  <path fill=\"#000\" class=\"path8 fill-color1\" d=\"M1307.236 185.406c-11.846-10.339-37.908-10.856-63.152-1.852-30.154 10.769-56.992 40.493-43.078 43.078 18.523 3.662 29.896 2.369 71.509-10.037s46.395-20.979 34.721-31.145zM1255.543 213.192c-34.893 7.883-46.093 11.717-46.222 2.585 0-4.566 19.945-20.117 36.013-25.071 22.487-6.892 41.441-7.108 52.555-0.431 9.046 5.6-5.169 14.431-42.518 22.831zM674.597 196.219c-38.77-17.748-63.755-11.071-61.903 8.917 2.585 26.88 75.386 37.047 102.525 42.475s-1.852-33.601-40.579-51.392zM637.808 219.395c-13.483-4.049-12.923-12.493-12.923-17.231 0-22.745 53.718 6.591 73.232 20.677 39.976 29.293-24.124 7.194-60.309-3.446zM79.952 387.699s28.604 9.908 33.859 82.149c2.585 35.97 13.699 133.11-14.216 74.007 0 0 14.043 90.032-20.247 17.231 0 0 30.93 106.833-28.948 11.889 0 0-14.646 55.269-35.065-83.571 0 0-28.001 23.52-8.357-17.231s46.093-87.060 72.974-84.475z\"></path>\
  <path fill=\"#000\" class=\"path9 fill-color1\" d=\"M58.155 408.204l5.729 0.258c66.038-164.557 128.372-205.653 153.357-215.819-15.157 30.157-4.049 3.763 11.545-19.355-102.137 16.856-170.631 234.915-170.631 234.915z\"></path>\
  <path fill=\"#000\" class=\"path10 fill-color1\" d=\"M76.808 409.066l10.769 0.517c20.677-98.648 72.371-136.815 100.371-150.772-0.804-0.738 2.672-13.075 8.299-24.134-90.276 46.189-119.439 174.389-119.439 174.389zM921.863 287.759c0.258 21.194-32.136 28.517-28.001-2.369s16.111-27.57 20.893-22.831 7.108 15.293 7.108 25.114zM1048.597 280.005c-0.431-18.093-20.117-34.893-24.425-8.616s6.462 29.379 12.191 28.69 12.622-6.031 12.234-20.117zM884.127 501.726c17.748-2.757 36.745 24.554 16.37 45.145s-37.047-10.597-35.065-27.311c1.194-9.51 8.96-17.005 18.623-17.786zM1080.087 491.732c14.129-3.748 31.877 22.487 11.502 42.475s-34.462-9.779-30.801-21.108c3.877-12.32 6.892-18.093 19.299-21.323z\"></path>\
  <path fill=\"#000\" class=\"path11 fill-color1\" d=\"M244.811 158.095s127.079 70.217 59.232 186.526-146.464 63.927-146.464 63.927-9.692-139.658 87.232-250.281zM323.729 448.439c-28.302-78.66 36.185-108.814 72.801-29.724s-34.333 136.642-72.801 29.724zM628.504 685.926s-157.061-75.171-130.095-253.555 207.807-63.324 207.807-63.324-9.692 34.118 8.185 63.324c0 0-154.132 69.614-66.857 251.272 0 0-4.868 14.646-19.083 2.283zM580.817 142.415s-133.541-34.721-175.197 41.872 9.046 172.052 199.148 51.047c0 0-118.722-51.262-23.994-92.919zM240.675 596.928s-66.9 12.191 5.6 81.848zM528.434 716.081s92.617 53.072 0 112.347v-112.304zM696.308 832.692c11.071 30.801 33.299 11.286 17.662-19.471s-27.44-7.754-17.662 19.471z\"></path>\
  <path fill=\"#000\" class=\"path12 fill-color1\" d=\"M714.357 925.74c-0.705 2.27 2.66 19.796 8.466 36.166 1.962-0.199 17.231-8.719 29-20.689s-34.149-95.903-31.090-186.366l-13.354-10.769c-0.19 30.42 4.637 82.361 13.73 132.82-8.829-0.855-18.425 1.822-28.646 1.822-8.534 0-16.632-1.866-23.908-5.212 5.526-46.808 9.532-111.166 1.046-163.333l-9.132-5.902s12.062 131.042-17.231 240.158c0 0 29.508 25.847 65.995 19.902 1.545-4.329 4.256-20.955 5.145-38.063z\"></path>\
  <path fill=\"#000\" class=\"path13 fill-color1\" d=\"M652.455 691.828l-8.616-10.166c-15.734 2.455-33.882 3.857-52.357 3.857-2.417 0-4.829-0.024-7.235-0.072s0.705 116.315 12.853 211.948c-8.128 2.939-17.508 4.638-27.285 4.638-17.867 0-34.409-5.674-47.922-15.319 9.427-56.347 17.483-131.087 11.021-197.987 0 0-168.434 4.868-325.237-162.058 1.193 15.459 10.859 32.352 25.182 43.57s3.723 76.359 11.434 138.261c-11.416 6.332-36.099 16.37-58.844 0.862 3.014-24.676 4.733-53.244 4.733-82.214s-1.72-57.538-5.062-85.608c-14.748-122.048-63.426-213.588 65.29-380.73s450.162-39.847 471.701-27.053l-11.329-21.237s-344.191-132.033-470.15 39.201c-140.003 190.317-80.771 292.928-68.924 393.041s-8.616 234.946-8.616 234.946 28.862 34.247 66.167 28.561c2.169-7.821 3.415-16.801 3.415-26.072 0-2.801-0.114-5.576-0.337-8.32-0.039 6.908 3.519 19.947 9.482 31.546 4.974-0.503 21.371-11.099 33.149-25.598s-26.454-37.421-30.029-198.317c0 0 131.042 117.43 277.119 119.584 0 0 15.077 141.424-37.391 278.583 0 0 40.364 41.656 84.432 44.37 3.619-7.668 8.314-22.185 9.908-47.945-0.705 3.289 2.582 26.427 8.462 48.508 14.628-5.085 29.49-13.916 42.628-31.535 0 0-34.979-95.891-33.385-295.944 0.215 0.086 49.841-2.585 55.699-5.299z\"></path>\
  <path fill=\"#000\" class=\"path14 fill-color1\" d=\"M348.24 749.466v0c-0.006 6.591 2.012 16.914 5.591 26.476 8.71-1.379 21.972-8.494 31.632-18.98s-16.417-35.884-19.346-103.429l-8.616-4.308c-0.011 19.070 1.883 43.615 5.507 67.593-6.128-0.522-12.822 0.749-19.813 0.749-12.056 0-23.229-3.781-32.398-10.221 2.765-26.674 5.565-58.466 5.78-78.023l-10.769-12.277s2.154 78.272-16.499 145.043c0 0 26.708 17.231 56.001 14.646 1.93-6.648 3.041-14.284 3.041-22.179 0-1.775-0.056-3.537-0.167-5.284z\"></path>\
</svg> "

		cow_svg.style.display = '-webkit-box';
		cow_svg.style.display = '-moz-box';
		cow_svg.style.display = 'box';

		cowrand.set( 2 * Math.PI * Math.random(), 2 * Math.PI * Math.random(), 2 * Math.PI * Math.random(), 'XYZ' );
		cow.position.applyEuler(cowrand);
		
		pause = true;
		
		document.dispatchEvent(pauseEvent);
	}
}

var raycaster = new THREE.Raycaster();
var mouse = new THREE.Vector2();
var obj = [earth.children[0]];
function onMouseMove( event ) {
	mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
	mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;

	// update the picking ray with the camera and mouse position
	raycaster.setFromCamera( mouse, camera );

	// calculate objects intersecting the picking ray
	var intersects = raycaster.intersectObjects( obj, true );
	
	// Toggle rotation bool for meshes that we clicked
	if ( intersects.length > 0 ) {
		tractor.position.set( 0, 0, 0 );
		tractor.lookAt( intersects[ 0 ].point );
		tractor.position.copy( intersects[ 0 ].point );
	
		// 3D Sound Spatial Transform Update
		listener.position.copy( audioPos.setFromMatrixPosition( tractor.matrixWorld ) );
		listener.rotation.copy( audioRot.setFromRotationMatrix( tractor.matrixWorld ) );
		
		// Max is approx 2, goes down to approx 0.1
		let sound_model = Math.max(10 - Math.floor(tractor.position.distanceTo(cow.position)/ 0.2),0);

		if (current_sound != sound_model) {
			sound.pause();
			sound.setBuffer( returnedMoos[sound_model] );
			sound.play();
			current_sound = sound_model;
		}
	
		// Visual fix
		tractor.rotateX(Math.PI/2);
	}
}

// dat.gui
var gui = new dat.GUI();
var guiMarkers = gui.addFolder('Markers');
// dat.gui controls object
var markersControls = new function() {
  this.address = '';
  this.color = 0xff0000;
  this.placeMarker= function() {
    placeMarkerAtAddress(this.address, this.color);
  }
}
guiMarkers.add(markersControls, 'address');
guiMarkers.addColor(markersControls, 'color');
guiMarkers.add(markersControls, 'placeMarker');
guiMarkers.open();

// stats
stats = new Stats();
document.body.appendChild( stats.dom );